#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

if ! command -v antlr4 &> /dev/null && ! command -v antlr &> /dev/null; then
    echo "Error: ANTLR is not installed or not in PATH." >&2
    echo "Please install ANTLR." >&2
    exit 1
fi


# Clean up.

find "$PROJECT_ROOT/grammar" \
    -type f \( -name "*.js" -o -name "*.interp" -o -name "*.tokens" \) \
    -delete
rm -f "$PROJECT_ROOT/parser.bundle.js"
rm -f "$PROJECT_ROOT/parser.bundle.min.js"
rm -f "$PROJECT_ROOT/parser.bundle.min.js.map"
rm -rf "$PROJECT_ROOT/output"


# Check grammar generation.

"$PROJECT_ROOT/generate-grammar.sh" &> /dev/null
if [ ! -f "$PROJECT_ROOT/grammar/IconScriptLexer.js" ]; then
    echo "Error: grammar was not created." >&2
    exit 1
fi
echo "Grammar generated."


# Check parser build.

npm run build:parser:min &> /dev/null
# Check that `parser.bundle.min.js` was created.
if [ ! -f "$PROJECT_ROOT/parser.bundle.min.js" ]; then
    echo "Error: parser.bundle.min.js was not created." >&2
    exit 1
fi
echo "Bundled minified parser created."


# Check SVG icons creation.

mkdir -p "$PROJECT_ROOT/output"
mkdir -p "$PROJECT_ROOT/output/main"
npm run generate -- \
    -i "$PROJECT_ROOT/test/main.iconscript" \
    -o "$PROJECT_ROOT/output/main" &> /dev/null

if [ ! -d "$PROJECT_ROOT/output" ]; then
    echo "Error: output directory was not created." >&2
    exit 1
fi
if [ ! -s "$PROJECT_ROOT/output" ]; then
    echo "Error: output directory is empty." >&2
    exit 1
fi
echo "SVG icons created."