#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

if ! command -v antlr4 &> /dev/null && ! command -v antlr &> /dev/null; then
    echo "Error: ANTLR is not installed or not in PATH." >&2
    echo "Please install ANTLR." >&2
    exit 1
fi

echo "Cleaning up..."
find "$PROJECT_ROOT/grammar" \
    -type f \( -name "*.ts" -o -name "*.interp" -o -name "*.tokens" \) \
    -delete
rm -f "$PROJECT_ROOT/web/bundles/parser.bundle.js"
rm -f "$PROJECT_ROOT/web/bundles/parser.bundle.min.js"
rm -f "$PROJECT_ROOT/web/bundles/parser.bundle.min.js.map"
rm -f "$PROJECT_ROOT/web/bundles/ui.bundle.js"
rm -f "$PROJECT_ROOT/web/bundles/ui.bundle.min.js"
rm -f "$PROJECT_ROOT/web/bundles/ui.bundle.min.js.map"
rm -rf "$PROJECT_ROOT/output"

echo "Generating grammar..."
"$PROJECT_ROOT/scripts/generate-grammar.sh"
if [ ! -f "$PROJECT_ROOT/grammar/IconScriptLexer.ts" ]; then
    echo "Error: grammar was not created." >&2
    exit 1
fi

echo "Building parser..."
npm run build:parser:min
# Check that `parser.bundle.min.js` was created.
if [ ! -f "$PROJECT_ROOT/web/bundles/parser.bundle.min.js" ]; then
    echo "Error: parser.bundle.min.js was not created." >&2
    exit 1
fi

echo "Creating SVG icons..."
mkdir -p "$PROJECT_ROOT/output"
mkdir -p "$PROJECT_ROOT/output/main"
npm run generate -- \
    "$PROJECT_ROOT/test/main.iconscript" \
    "$PROJECT_ROOT/output/main" &> /dev/null
if [ ! -d "$PROJECT_ROOT/output" ]; then
    echo "Error: output directory was not created." >&2
    exit 1
fi
if [ ! -s "$PROJECT_ROOT/output" ]; then
    echo "Error: output directory is empty." >&2
    exit 1
fi

echo "Creating command-line interface..."
rm -rf "$PROJECT_ROOT/dist"
npm run build:cli
# Check that `iconscript` was created.
if [ ! -f "$PROJECT_ROOT/dist/cli/generate-svg.js" ]; then
    echo "Error: iconscript was not created." >&2
    exit 1
fi

echo "Building library..."
rm -rf "$PROJECT_ROOT/dist"
npm run build:lib
# Check that `dist/` was created.
if [ ! -f "$PROJECT_ROOT/dist/src/parser.js" ]; then
    echo "Error: dist/src/parser.js was not created." >&2
    exit 1
fi

echo "Checking Prettier formatting..."
if ! npm run format:check; then
    echo "Error: Prettier formatting check failed." >&2
    echo "Run 'npm run format' to fix formatting issues." >&2
    exit 1
fi

echo "Checking ESLint for TypeScript files..."
if ! npm run lint:ts; then
    echo "Error: ESLint check for TypeScript files failed." >&2
    exit 1
fi

echo "Checking ESLint for HTML files..."
if ! npm run lint:html; then
    echo "Error: ESLint check for HTML files failed." >&2
    exit 1
fi

echo "Checking Stylelint for CSS files..."
if ! npm run lint:css; then
    echo "Error: Stylelint check for CSS files failed." >&2
    exit 1
fi